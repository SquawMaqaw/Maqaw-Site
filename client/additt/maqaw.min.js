function ChatManager(a){this.chatWindow=a;this.activeVisitor=undefined;this.noChatSession=document.createElement("DIV");this.noChatSession.id="no-chat-session-selected";this.noChatSession.innerHTML="No visitor selected";a.appendChild(this.noChatSession)}ChatManager.prototype.showVisitorChat=function(a){this.activeVisitor=a;this.chatWindow.innerHTML="";this.chatWindow.appendChild(a.chatSession.getContainer())};ChatManager.prototype.clear=function(a){if(!a||a&&a===this.activeVisitor){this.chatWindow.innerHTML="";this.chatWindow.appendChild(this.noChatSession)}};function LoginPage(e){var h=this;var j="http://ec2-54-214-126-127.us-west-2.compute.amazonaws.com:3000/login";var f="additt";var n="MapleAdditt";this.maqawManager=e;this.header=document.createElement("DIV");this.header.className="maqaw-default-client-header";this.loginHeader=document.createElement("DIV");this.loginHeader.innerHTML="Login";this.loginHeader.className="maqaw-chat-header-text";this.header.appendChild(this.loginHeader);this.body=document.createElement("DIV");this.body.id="login-window";var b;b=document.createElement("DIV");b.id="login-title";b.innerHTML="Login to your account";this.body.appendChild(b);var i=document.createElement("DIV");i.id="maqaw-login-error-message";i.innerHTML="Invalid username or password";i.style.display="none";this.body.appendChild(i);var m=document.createElement("input");m.setAttribute("type","text");m.setAttribute("name","username");m.setAttribute("size","31");m.setAttribute("placeholder","username");m.value=f;this.body.appendChild(m);var d=document.createElement("input");d.setAttribute("type","password");d.setAttribute("name","password");d.setAttribute("size","31");d.setAttribute("placeholder","password");d.value=n;this.body.appendChild(d);var l=document.createElement("DIV");l.id="login-submit-button";l.className="login-page-button";l.innerHTML="Login";this.body.appendChild(l);l.addEventListener("click",c,false);var a=document.createElement("DIV");a.id="login-back-button";a.className="login-page-button";a.innerHTML="Back";this.body.appendChild(a);a.addEventListener("click",this.maqawManager.showVisitorSession,false);var k=document.createElement("DIV");k.id="login-footer";k.innerHTML="Don't have an account? Sign up at <a href='http://maqaw.com'>Maqaw.com</a>!";this.body.appendChild(k);function c(){var p=h.maqawManager.key;var s=h.maqawManager.id;var r=m.value;var o=d.value;var q=encodeURI("username="+r+"&password="+o+"&user[id]="+s+"&user[key]="+p);docCookies.setItem("maqawRepLoginCookie",q);maqawAjaxPost(j,q,g)}function g(p){if(p.status===401){i.style.display="block";docCookies.removeItem("maqawRepLoginCookie")}else{if(p.status===200){i.style.display="none";var o=new Representative("RepName");h.maqawManager.startNewRepSession(o);clearInterval(h.loginInterval)}}}this.loginWithParams=function(o){h.loginInterval=setInterval(function(){maqawAjaxPost(j,o,g)},100)}}LoginPage.prototype.getBodyContents=function(){return this.body};LoginPage.prototype.getHeaderContents=function(){return this.header};
/*! peerjs.js build:0.2.8, development. Copyright(c) 2013 Michelle Bu <michelle@michellebu.com> */
(function(f){var d={};d.useBlobBuilder=(function(){try{new Blob([]);return false}catch(n){return true}})();d.useArrayBufferView=!d.useBlobBuilder&&(function(){try{return(new Blob([new Uint8Array([])])).size===0}catch(n){return true}})();f.binaryFeatures=d;f.BlobBuilder=window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder||window.BlobBuilder;function c(){this._pieces=[];this._parts=[]}c.prototype.append=function(n){if(typeof n==="number"){this._pieces.push(n)}else{this._flush();this._parts.push(n)}};c.prototype._flush=function(){if(this._pieces.length>0){var n=new Uint8Array(this._pieces);if(!d.useArrayBufferView){n=n.buffer}this._parts.push(n);this._pieces=[]}};c.prototype.getBuffer=function(){this._flush();if(d.useBlobBuilder){var n=new BlobBuilder();for(var o=0,p=this._parts.length;o<p;o++){n.append(this._parts[o])}return n.getBlob()}else{return new Blob(this._parts)}};f.BinaryPack={unpack:function(o){var n=new j(o);return n.unpack()},pack:function(p,o){var q=new h(o);var n=q.pack(p);return n}};function j(n){this.index=0;this.dataBuffer=n;this.dataView=new Uint8Array(this.dataBuffer);this.length=this.dataBuffer.byteLength}j.prototype.unpack=function(){var q=this.unpack_uint8();if(q<128){var p=q;return p}else{if((q^224)<32){var n=(q^224)-32;return n}}var o;if((o=q^160)<=15){return this.unpack_raw(o)}else{if((o=q^176)<=15){return this.unpack_string(o)}else{if((o=q^144)<=15){return this.unpack_array(o)}else{if((o=q^128)<=15){return this.unpack_map(o)}}}}switch(q){case 192:return null;case 193:return undefined;case 194:return false;case 195:return true;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 212:return undefined;case 213:return undefined;case 214:return undefined;case 215:return undefined;case 216:o=this.unpack_uint16();return this.unpack_string(o);case 217:o=this.unpack_uint32();return this.unpack_string(o);case 218:o=this.unpack_uint16();return this.unpack_raw(o);case 219:o=this.unpack_uint32();return this.unpack_raw(o);case 220:o=this.unpack_uint16();return this.unpack_array(o);case 221:o=this.unpack_uint32();return this.unpack_array(o);case 222:o=this.unpack_uint16();return this.unpack_map(o);case 223:o=this.unpack_uint32();return this.unpack_map(o)}};j.prototype.unpack_uint8=function(){var n=this.dataView[this.index]&255;this.index++;return n};j.prototype.unpack_uint16=function(){var n=this.read(2);var o=((n[0]&255)*256)+(n[1]&255);this.index+=2;return o};j.prototype.unpack_uint32=function(){var n=this.read(4);var o=((n[0]*256+n[1])*256+n[2])*256+n[3];this.index+=4;return o};j.prototype.unpack_uint64=function(){var n=this.read(8);var o=((((((n[0]*256+n[1])*256+n[2])*256+n[3])*256+n[4])*256+n[5])*256+n[6])*256+n[7];this.index+=8;return o};j.prototype.unpack_int8=function(){var n=this.unpack_uint8();return(n<128)?n:n-(1<<8)};j.prototype.unpack_int16=function(){var n=this.unpack_uint16();return(n<32768)?n:n-(1<<16)};j.prototype.unpack_int32=function(){var n=this.unpack_uint32();return(n<Math.pow(2,31))?n:n-Math.pow(2,32)};j.prototype.unpack_int64=function(){var n=this.unpack_uint64();return(n<Math.pow(2,63))?n:n-Math.pow(2,64)};j.prototype.unpack_raw=function(o){if(this.length<this.index+o){throw new Error("BinaryPackFailure: index is out of range "+this.index+" "+o+" "+this.length)}var n=this.dataBuffer.slice(this.index,this.index+o);this.index+=o;return n};j.prototype.unpack_string=function(p){var n=this.read(p);var o=0,r="",s,q;while(o<p){s=n[o];if(s<128){r+=String.fromCharCode(s);o++}else{if((s^192)<32){q=((s^192)<<6)|(n[o+1]&63);r+=String.fromCharCode(q);o+=2}else{q=((s&15)<<12)|((n[o+1]&63)<<6)|(n[o+2]&63);r+=String.fromCharCode(q);o+=3}}}this.index+=p;return r};j.prototype.unpack_array=function(o){var p=new Array(o);for(var n=0;n<o;n++){p[n]=this.unpack()}return p};j.prototype.unpack_map=function(p){var r={};for(var o=0;o<p;o++){var n=this.unpack();var q=this.unpack();r[n]=q}return r};j.prototype.unpack_float=function(){var o=this.unpack_uint32();var n=o>>31;var q=((o>>23)&255)-127;var p=(o&8388607)|8388608;return(n==0?1:-1)*p*Math.pow(2,q-23)};j.prototype.unpack_double=function(){var s=this.unpack_uint32();var q=this.unpack_uint32();var o=s>>31;var r=((s>>20)&2047)-1023;var n=(s&1048575)|1048576;var p=n*Math.pow(2,r-20)+q*Math.pow(2,r-52);return(o==0?1:-1)*p};j.prototype.read=function(o){var n=this.index;if(n+o<=this.length){return this.dataView.subarray(n,n+o)}else{throw new Error("BinaryPackFailure: read index out of range")}};function h(n){this.utf8=n;this.bufferBuilder=new c()}h.prototype.pack=function(p){var o=typeof(p);if(o=="string"){this.pack_string(p)}else{if(o=="number"){if(Math.floor(p)===p){this.pack_integer(p)}else{this.pack_double(p)}}else{if(o=="boolean"){if(p===true){this.bufferBuilder.append(195)}else{if(p===false){this.bufferBuilder.append(194)}}}else{if(o=="undefined"){this.bufferBuilder.append(192)}else{if(o=="object"){if(p===null){this.bufferBuilder.append(192)}else{var n=p.constructor;if(n==Array){this.pack_array(p)}else{if(n==Blob||n==File){this.pack_bin(p)}else{if(n==ArrayBuffer){if(d.useArrayBufferView){this.pack_bin(new Uint8Array(p))}else{this.pack_bin(p)}}else{if("BYTES_PER_ELEMENT" in p){if(d.useArrayBufferView){this.pack_bin(p)}else{this.pack_bin(p.buffer)}}else{if(n==Object){this.pack_object(p)}else{if(n==Date){this.pack_string(p.toString())}else{if(typeof p.toBinaryPack=="function"){this.bufferBuilder.append(p.toBinaryPack())}else{throw new Error('Type "'+n.toString()+'" not yet supported')}}}}}}}}}else{throw new Error('Type "'+o+'" not yet supported')}}}}}return this.bufferBuilder.getBuffer()};h.prototype.pack_bin=function(n){var o=n.length||n.byteLength||n.size;if(o<=15){this.pack_uint8(160+o)}else{if(o<=65535){this.bufferBuilder.append(218);this.pack_uint16(o)}else{if(o<=4294967295){this.bufferBuilder.append(219);this.pack_uint32(o)}else{throw new Error("Invalid length");return}}}this.bufferBuilder.append(n)};h.prototype.pack_string=function(p){var o;if(this.utf8){var n=new Blob([p]);o=n.size}else{o=p.length}if(o<=15){this.pack_uint8(176+o)}else{if(o<=65535){this.bufferBuilder.append(216);this.pack_uint16(o)}else{if(o<=4294967295){this.bufferBuilder.append(217);this.pack_uint32(o)}else{throw new Error("Invalid length");return}}}this.bufferBuilder.append(p)};h.prototype.pack_array=function(o){var p=o.length;if(p<=15){this.pack_uint8(144+p)}else{if(p<=65535){this.bufferBuilder.append(220);this.pack_uint16(p)}else{if(p<=4294967295){this.bufferBuilder.append(221);this.pack_uint32(p)}else{throw new Error("Invalid length")}}}for(var n=0;n<p;n++){this.pack(o[n])}};h.prototype.pack_integer=function(n){if(-32<=n&&n<=127){this.bufferBuilder.append(n&255)}else{if(0<=n&&n<=255){this.bufferBuilder.append(204);this.pack_uint8(n)}else{if(-128<=n&&n<=127){this.bufferBuilder.append(208);this.pack_int8(n)}else{if(0<=n&&n<=65535){this.bufferBuilder.append(205);this.pack_uint16(n)}else{if(-32768<=n&&n<=32767){this.bufferBuilder.append(209);this.pack_int16(n)}else{if(0<=n&&n<=4294967295){this.bufferBuilder.append(206);this.pack_uint32(n)}else{if(-2147483648<=n&&n<=2147483647){this.bufferBuilder.append(210);this.pack_int32(n)}else{if(-9223372036854776000<=n&&n<=9223372036854776000){this.bufferBuilder.append(211);this.pack_int64(n)}else{if(0<=n&&n<=18446744073709552000){this.bufferBuilder.append(207);this.pack_uint64(n)}else{throw new Error("Invalid integer")}}}}}}}}}};h.prototype.pack_double=function(p){var o=0;if(p<0){o=1;p=-p}var u=Math.floor(Math.log(p)/Math.LN2);var t=p/Math.pow(2,u)-1;var r=Math.floor(t*Math.pow(2,52));var n=Math.pow(2,32);var s=(o<<31)|((u+1023)<<20)|(r/n)&1048575;var q=r%n;this.bufferBuilder.append(203);this.pack_int32(s);this.pack_int32(q)};h.prototype.pack_object=function(p){var o=Object.keys(p);var n=o.length;if(n<=15){this.pack_uint8(128+n)}else{if(n<=65535){this.bufferBuilder.append(222);this.pack_uint16(n)}else{if(n<=4294967295){this.bufferBuilder.append(223);this.pack_uint32(n)}else{throw new Error("Invalid length")}}}for(var q in p){if(p.hasOwnProperty(q)){this.pack(q);this.pack(p[q])}}};h.prototype.pack_uint8=function(n){this.bufferBuilder.append(n)};h.prototype.pack_uint16=function(n){this.bufferBuilder.append(n>>8);this.bufferBuilder.append(n&255)};h.prototype.pack_uint32=function(o){var p=o&4294967295;this.bufferBuilder.append((p&4278190080)>>>24);this.bufferBuilder.append((p&16711680)>>>16);this.bufferBuilder.append((p&65280)>>>8);this.bufferBuilder.append((p&255))};h.prototype.pack_uint64=function(o){var p=o/Math.pow(2,32);var n=o%Math.pow(2,32);this.bufferBuilder.append((p&4278190080)>>>24);this.bufferBuilder.append((p&16711680)>>>16);this.bufferBuilder.append((p&65280)>>>8);this.bufferBuilder.append((p&255));this.bufferBuilder.append((n&4278190080)>>>24);this.bufferBuilder.append((n&16711680)>>>16);this.bufferBuilder.append((n&65280)>>>8);this.bufferBuilder.append((n&255))};h.prototype.pack_int8=function(n){this.bufferBuilder.append(n&255)};h.prototype.pack_int16=function(n){this.bufferBuilder.append((n&65280)>>8);this.bufferBuilder.append(n&255)};h.prototype.pack_int32=function(n){this.bufferBuilder.append((n>>>24)&255);this.bufferBuilder.append((n&16711680)>>>16);this.bufferBuilder.append((n&65280)>>>8);this.bufferBuilder.append((n&255))};h.prototype.pack_int64=function(o){var p=Math.floor(o/Math.pow(2,32));var n=o%Math.pow(2,32);this.bufferBuilder.append((p&4278190080)>>>24);this.bufferBuilder.append((p&16711680)>>>16);this.bufferBuilder.append((p&65280)>>>8);this.bufferBuilder.append((p&255));this.bufferBuilder.append((n&4278190080)>>>24);this.bufferBuilder.append((n&16711680)>>>16);this.bufferBuilder.append((n&65280)>>>8);this.bufferBuilder.append((n&255))};function m(){this._events={}}var i=Array.isArray;m.prototype.addListener=function(p,q,o,n){if("function"!==typeof q){throw new Error("addListener only takes instances of Function")}this.emit("newListener",p,typeof q.listener==="function"?q.listener:q);if(!this._events[p]){this._events[p]=q}else{if(i(this._events[p])){this._events[p].push(q)}else{this._events[p]=[this._events[p],q]}}return this};m.prototype.on=m.prototype.addListener;m.prototype.once=function(p,r,o){if("function"!==typeof r){throw new Error(".once only takes instances of Function")}var n=this;function q(){n.removeListener(p,q);r.apply(this,arguments)}q.listener=r;n.on(p,q);return this};m.prototype.removeListener=function(q,t,p){if("function"!==typeof t){throw new Error("removeListener only takes instances of Function")}if(!this._events[q]){return this}var s=this._events[q];if(i(s)){var n=-1;for(var o=0,r=s.length;o<r;o++){if(s[o]===t||(s[o].listener&&s[o].listener===t)){n=o;break}}if(n<0){return this}s.splice(n,1);if(s.length==0){delete this._events[q]}}else{if(s===t||(s.listener&&s.listener===t)){delete this._events[q]}}return this};m.prototype.off=m.prototype.removeListener;m.prototype.removeAllListeners=function(n){if(arguments.length===0){this._events={};return this}if(n&&this._events&&this._events[n]){this._events[n]=null}return this};m.prototype.listeners=function(n){if(!this._events[n]){this._events[n]=[]}if(!i(this._events[n])){this._events[n]=[this._events[n]]}return this._events[n]};m.prototype.emit=function(s){var s=arguments[0];var r=this._events[s];if(!r){return false}if(typeof r=="function"){switch(arguments.length){case 1:r.call(this);break;case 2:r.call(this,arguments[1]);break;case 3:r.call(this,arguments[1],arguments[2]);break;default:var n=arguments.length;var o=new Array(n-1);for(var p=1;p<n;p++){o[p-1]=arguments[p]}r.apply(this,o)}return true}else{if(i(r)){var n=arguments.length;var o=new Array(n-1);for(var p=1;p<n;p++){o[p-1]=arguments[p]}var q=r.slice();for(var p=0,n=q.length;p<n;p++){q[p].apply(this,o)}return true}else{return false}}};var g={chromeCompatible:true,firefoxCompatible:true,chromeVersion:26,firefoxVersion:22,debug:false,browserisms:"",inherits:function(o,n){o.super_=n;o.prototype=Object.create(n.prototype,{constructor:{value:o,enumerable:false,writable:true,configurable:true}})},extend:function(n,p){for(var o in p){if(p.hasOwnProperty(o)){n[o]=p[o]}}return n},pack:BinaryPack.pack,unpack:BinaryPack.unpack,log:function(){if(g.debug){var p=false;var q=Array.prototype.slice.call(arguments);q.unshift("PeerJS: ");for(var o=0,n=q.length;o<n;o++){if(q[o] instanceof Error){q[o]="("+q[o].name+") "+q[o].message;p=true}}p?console.error.apply(console,q):console.log.apply(console,q)}},setZeroTimeout:(function(q){var o=[];var n="zero-timeout-message";function p(s){o.push(s);q.postMessage(n,"*")}function r(s){if(s.source==q&&s.data==n){if(s.stopPropagation){s.stopPropagation()}if(o.length){o.shift()()}}}if(q.addEventListener){q.addEventListener("message",r,true)}else{if(q.attachEvent){q.attachEvent("onmessage",r)}}return p}(this)),blobToArrayBuffer:function(p,n){var o=new FileReader();o.onload=function(q){n(q.target.result)};o.readAsArrayBuffer(p)},blobToBinaryString:function(p,n){var o=new FileReader();o.onload=function(q){n(q.target.result)};o.readAsBinaryString(p)},binaryStringToArrayBuffer:function(p){var n=new Uint8Array(p.length);for(var o=0;o<p.length;o++){n[o]=p.charCodeAt(o)&255}return n.buffer},randomToken:function(){return Math.random().toString(36).substr(2)},isBrowserCompatible:function(){var p,o;if(this.chromeCompatible){if((p=navigator.userAgent.split("Chrome/"))&&p.length>1){var n=p[1].split(".")[0];return parseInt(n)>=this.chromeVersion}}if(this.firefoxCompatible){if((o=navigator.userAgent.split("Firefox/"))&&o.length>1){var n=o[1].split(".")[0];return parseInt(n)>=this.firefoxVersion}}return false},isSecure:function(){return location.protocol==="https:"}};function a(n,o){if(!(this instanceof a)){return new a(n)}this._dc=n;g.debug=o;this._outgoing={};this._incoming={};this._received={};this._window=1000;this._mtu=500;this._interval=0;this._count=0;this._queue=[];this._setupDC()}a.prototype.send=function(n){var o=g.pack(n);if(o.size<this._mtu){this._handleSend(["no",o]);return}this._outgoing[this._count]={ack:0,chunks:this._chunk(o)};if(g.debug){this._outgoing[this._count].timer=new Date()}this._sendWindowedChunks(this._count);this._count+=1};a.prototype._setupInterval=function(){var n=this;this._timeout=setInterval(function(){var q=n._queue.shift();if(q._multiple){for(var o=0,p=q.length;o<p;o+=1){n._intervalSend(q[o])}}else{n._intervalSend(q)}},this._interval)};a.prototype._intervalSend=function(o){var n=this;o=g.pack(o);g.blobToBinaryString(o,function(p){n._dc.send(p)});if(n._queue.length===0){clearTimeout(n._timeout);n._timeout=null}};a.prototype._processAcks=function(){for(var n in this._outgoing){if(this._outgoing.hasOwnProperty(n)){this._sendWindowedChunks(n)}}};a.prototype._handleSend=function(r){var n=true;for(var o=0,p=this._queue.length;o<p;o+=1){var q=this._queue[o];if(q===r){n=false}else{if(q._multiple&&q.indexOf(r)!==-1){n=false}}}if(n){this._queue.push(r);if(!this._timeout){this._setupInterval()}}};a.prototype._setupDC=function(){var n=this;this._dc.onmessage=function(q){var r=q.data;var o=r.constructor;if(o===String){var p=g.binaryStringToArrayBuffer(r);r=g.unpack(p);n._handleMessage(r)}}};a.prototype._handleMessage=function(q){var o=q[1];var r=this._incoming[o];var v=this._outgoing[o];var t;switch(q[0]){case"no":var x=o;if(!!x){this.onmessage(g.unpack(x))}break;case"end":t=r;this._received[o]=q[2];if(!t){break}this._ack(o);break;case"ack":t=v;if(!!t){var w=q[2];t.ack=Math.max(w,t.ack);if(t.ack>=t.chunks.length){g.log("Time: ",new Date()-t.timer);delete this._outgoing[o]}else{this._processAcks()}}break;case"chunk":t=r;if(!t){var s=this._received[o];if(s===true){break}t={ack:["ack",o,0],chunks:[]};this._incoming[o]=t}var p=q[2];var u=q[3];t.chunks[p]=new Uint8Array(u);if(p===t.ack[2]){this._calculateNextAck(o)}this._ack(o);break;default:this._handleSend(q);break}};a.prototype._chunk=function(t){var s=[];var q=t.size;var r=0;while(r<q){var o=Math.min(q,r+this._mtu);var n=t.slice(r,o);var p={payload:n};s.push(p);r=o}g.log("Created",s.length,"chunks.");return s};a.prototype._ack=function(o){var n=this._incoming[o].ack;if(this._received[o]===n[2]){this._complete(o);this._received[o]=true}this._handleSend(n)};a.prototype._calculateNextAck=function(r){var p=this._incoming[r];var q=p.chunks;for(var n=0,o=q.length;n<o;n+=1){if(q[n]===undefined){p.ack[2]=n;return}}p.ack[2]=q.length};a.prototype._sendWindowedChunks=function(s){g.log("sendWindowedChunks for: ",s);var q=this._outgoing[s];var p=q.chunks;var r=[];var n=Math.min(q.ack+this._window,p.length);for(var o=q.ack;o<n;o+=1){if(!p[o].sent||o===q.ack){p[o].sent=true;r.push(["chunk",s,o,p[o].payload])}}if(q.ack+this._window>=p.length){r.push(["end",s,p.length])}r._multiple=true;this._handleSend(r)};a.prototype._complete=function(q){g.log("Completed called for",q);var n=this;var p=this._incoming[q].chunks;var o=new Blob(p);g.blobToArrayBuffer(o,function(r){n.onmessage(g.unpack(r))});delete this._incoming[q]};a.higherBandwidthSDP=function(n){var p=n.split("b=AS:30");var o="b=AS:102400";return p[0]+o+p[1]};a.prototype.onmessage=function(n){};f.Reliable=a;if(window.mozRTCPeerConnection){g.browserisms="Firefox"}else{if(window.webkitRTCPeerConnection){g.browserisms="Webkit"}else{g.browserisms="Unknown"}}f.RTCSessionDescription=window.mozRTCSessionDescription||window.RTCSessionDescription;f.RTCPeerConnection=window.mozRTCPeerConnection||window.webkitRTCPeerConnection||window.RTCPeerConnection;function l(p,o){if(p&&p.constructor==Object){o=p;p=undefined}if(!(this instanceof l)){return new l(p,o)}m.call(this);o=g.extend({debug:false,host:"0.peerjs.com",port:9000,key:"peerjs",config:{iceServers:[{url:"stun:stun.l.google.com:19302"}]}},o);this._options=o;g.debug=o.debug;var n=this;if(!g.isBrowserCompatible()){g.setZeroTimeout(function(){n._abort("browser-incompatible","The current browser does not support WebRTC DataChannels")});return}if(o.host==="/"){o.host=window.location.hostname}if(p&&!/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(p)){g.setZeroTimeout(function(){n._abort("invalid-id",'ID "'+p+'" is invalid')});return}if(o.key&&!/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(o.key)){g.setZeroTimeout(function(){n._abort("invalid-key",'API KEY "'+o.key+'" is invalid')});return}this._secure=g.isSecure();if(this._secure&&o.host==="0.peerjs.com"){g.setZeroTimeout(function(){n._abort("ssl-unavailable","The cloud server currently does not support HTTPS. Please run your own PeerServer to use HTTPS.")});return}this.destroyed=false;this.disconnected=false;this.connections={};this.managers={};this._queued=[];if(p){this.id=p;this._init()}else{this.id=null;this._retrieveId()}}g.inherits(l,m);l.prototype._retrieveId=function(n){var o=this;try{var q=new XMLHttpRequest();var s=this._secure?"https://":"http://";var p=s+this._options.host+":"+this._options.port+"/"+this._options.key+"/id";var t="?ts="+new Date().getTime()+""+Math.random();p+=t;q.open("get",p,true);q.onreadystatechange=function(){if(q.readyState===4){if(q.status!==200){throw"Retrieve ID response not 200";return}o.id=q.responseText;o._init()}};q.send(null)}catch(r){this._abort("server-error","Could not get an ID from the server")}};l.prototype._init=function(){var n=this;this._socket=new b(this._options.host,this._options.port,this._options.key,this.id);this._socket.on("message",function(o){n._handleServerJSONMessage(o)});this._socket.on("error",function(o){g.log(o);n._abort("socket-error",o)});this._socket.on("close",function(){var o="Underlying socket has closed";g.log("error",o);n._abort("socket-closed",o)});this._socket.start()};l.prototype._handleServerJSONMessage=function(p){var q=p.src;var o=this.managers[q];var r=p.payload;switch(p.type){case"OPEN":this._processQueue();this.emit("open",this.id);break;case"ERROR":this._abort("server-error",r.msg);break;case"ID-TAKEN":this._abort("unavailable-id","ID `"+this.id+"` is taken");break;case"OFFER":var n={sdp:r.sdp,labels:r.labels,config:this._options.config};var o=this.managers[q];if(!o){o=new k(this.id,q,this._socket,n);this._attachManagerListeners(o);this.managers[q]=o;this.connections[q]=o.connections}o.update(n.labels);o.handleSDP(r.sdp,p.type);break;case"EXPIRE":if(o){o.close();o.emit("error",new Error("Could not connect to peer "+o.peer))}break;case"ANSWER":if(o){o.handleSDP(r.sdp,p.type)}break;case"CANDIDATE":if(o){o.handleCandidate(r)}break;case"LEAVE":if(o){o.handleLeave()}break;case"REPRESENTATIVES":this.emit("representatives",r);break;case"CLIENTS":this.emit("clients",r);break;case"INVALID-KEY":this._abort("invalid-key",'API KEY "'+this._key+'" is invalid');break;default:g.log("Unrecognized message type:",p.type);break}};l.prototype._processQueue=function(){while(this._queued.length>0){var n=this._queued.pop();n.initialize(this.id,this._socket)}};l.prototype._attachManagerListeners=function(o){var n=this;o.on("connection",function(p){n.emit("connection",p)});o.on("close",function(){if(!!n.managers[o.peer]){delete n.managers[o.peer];delete n.connections[o.peer]}});o.on("error",function(p){n.emit("error",p)})};l.prototype._abort=function(n,p){g.log("Aborting. Error:",p);var o=new Error(p);o.type=n;this.destroy();this.emit("error",o)};l.prototype._cleanup=function(){var o=this;if(!!this.managers){var n=Object.keys(this.managers);for(var p=0,q=n.length;p<q;p++){this.managers[n[p]].close()}}g.setZeroTimeout(function(){o.disconnect()});this.emit("close")};l.prototype.connect=function(r,o){if(this.disconnected){var q=new Error("This Peer has been disconnected from the server and can no longer make connections.");q.type="server-disconnected";this.emit("error",q);return}o=g.extend({config:this._options.config},o);var p=this.managers[r];if(g.browserisms==="Firefox"&&!!p&&p.firefoxSingular){var q=new Error("Firefox currently does not support multiplexing after a DataChannel has already been established");q.type="firefoxism";this.emit("error",q);return}if(!p){p=new k(this.id,r,this._socket,o);this._attachManagerListeners(p);this.managers[r]=p;this.connections[r]=p.connections}var n=p.connect(o);if(!this.id){this._queued.push(p)}return n};l.prototype.getId=function(){return this.id};l.prototype.destroy=function(){if(!this.destroyed){this._cleanup();this.destroyed=true}};l.prototype.disconnect=function(){if(!this.disconnected){if(!!this._socket){this._socket.close()}this.id=null;this.disconnected=true}};l.browser=g.browserisms;l.prototype.getIsConnected=function(){return !this.disconnected};l.prototype.isDestroyed=function(){return this.destroyed};f.Peer=l;function e(p,n,o){if(!(this instanceof e)){return new e(p,n,o)}m.call(this);o=g.extend({serialization:"binary"},o);this.open=false;this.label=o.label;this.metadata=o.metadata;this.serialization=o.serialization;this.peer=p;this.reliable=o.reliable;this._dc=n;if(!!this._dc){this._configureDataChannel()}}g.inherits(e,m);e.prototype._configureDataChannel=function(){var n=this;if(g.browserisms!=="Webkit"){this._dc.binaryType="arraybuffer"}this._dc.onopen=function(){g.log("Data channel connection success");n.open=true;n.emit("open")};if(this.reliable&&g.browserisms!=="Firefox"){this._reliable=new a(this._dc,g.debug)}if(this._reliable){this._reliable.onmessage=function(o){n.emit("data",o)}}else{this._dc.onmessage=function(o){n._handleDataMessage(o)}}this._dc.onclose=function(o){g.log("DataChannel closed.");n.close()}};e.prototype._cleanup=function(){if(!!this._dc&&this._dc.readyState!=="closed"){this._dc.close();this._dc=null}this.open=false;this.emit("close")};e.prototype._handleDataMessage=function(r){var n=this;var q=r.data;var o=q.constructor;if(this.serialization==="binary"||this.serialization==="binary-utf8"){if(o===Blob){g.blobToArrayBuffer(q,function(s){q=g.unpack(s);n.emit("data",q)});return}else{if(o===ArrayBuffer){q=g.unpack(q)}else{if(o===String){var p=g.binaryStringToArrayBuffer(q);q=g.unpack(p)}}}}else{if(this.serialization==="json"){q=JSON.parse(q)}}this.emit("data",q)};e.prototype.addDC=function(n){this._dc=n;this._configureDataChannel()};e.prototype.close=function(){if(!this.open){return}this._cleanup()};e.prototype.send=function(q){if(!this.open){this.emit("error",new Error("Connection no longer open."))}if(this._reliable){this._reliable.send(q);return}var o=this;if(this.serialization==="none"){this._dc.send(q)}else{if(this.serialization==="json"){this._dc.send(JSON.stringify(q))}else{var p=(this.serialization==="binary-utf8");var n=g.pack(q,p);if(g.browserisms==="Webkit"){g.blobToBinaryString(n,function(r){o._dc.send(r)})}else{this._dc.send(n)}}}};e.prototype.isOpen=function(){return this.open};e.prototype.getMetadata=function(){return this.metadata};e.prototype.getLabel=function(){return this.label};e.prototype.getPeer=function(){return this.peer};function k(q,p,n,o){if(!(this instanceof k)){return new k(q,p,n,o)}m.call(this);o=g.extend({config:{iceServers:[{url:"stun:stun.l.google.com:19302"}]}},o);this._options=o;this.open=true;this.id=q;this.peer=p;this.pc=null;this.labels={};this._default=0;this.connections={};this._queued=[];this._socket=n;if(!!this.id){this.initialize()}}g.inherits(k,m);k.prototype.initialize=function(o,n){if(!!o){this.id=o}if(!!n){this._socket=n}this._startPeerConnection();this._processQueue();this._setupIce();this._setupNegotiationHandler();this._setupDataChannel();this.initialize=function(){}};k.prototype._startPeerConnection=function(){g.log("Creating RTCPeerConnection");this.pc=new RTCPeerConnection(this._options.config,{optional:[{RtpDataChannels:true}]})};k.prototype._processQueue=function(){var n=this._queued.pop();if(!!n){var o=g.browserisms==="Firefox"?n.reliable:false;n.addDC(this.pc.createDataChannel(n.label,{reliable:o}))}};k.prototype._setupIce=function(){g.log("Listening for ICE candidates.");var n=this;this.pc.onicecandidate=function(o){if(o.candidate){g.log("Received ICE candidates.");n._socket.send({type:"CANDIDATE",payload:{candidate:o.candidate},dst:n.peer})}};this.pc.oniceconnectionstatechange=function(){if(!!n.pc&&n.pc.iceConnectionState==="disconnected"){g.log("iceConnectionState is disconnected, closing connections to "+this.peer);n.close()}};this.pc.onicechange=function(){if(!!n.pc&&n.pc.iceConnectionState==="disconnected"){g.log("iceConnectionState is disconnected, closing connections to "+this.peer);n.close()}}};k.prototype._setupNegotiationHandler=function(){var n=this;g.log("Listening for `negotiationneeded`");this.pc.onnegotiationneeded=function(){g.log("`negotiationneeded` triggered");n._makeOffer()}};k.prototype._setupDataChannel=function(){var n=this;g.log("Listening for data channel");this.pc.ondatachannel=function(p){g.log("Received data channel");var o=p.channel;var s=o.label;var r=n.labels[s]||{};var q=new e(n.peer,o,r);n._attachConnectionListeners(q);n.connections[s]=q;n.emit("connection",q)}};k.prototype._makeOffer=function(){var n=this;this.pc.createOffer(function(o){g.log("Created offer.");n.firefoxSingular=true;if(g.browserisms==="Webkit"){o.sdp=a.higherBandwidthSDP(o.sdp)}n.pc.setLocalDescription(o,function(){g.log("Set localDescription to offer");n._socket.send({type:"OFFER",payload:{sdp:o,config:n._options.config,labels:n.labels},dst:n.peer});n.labels={}},function(p){n.emit("error",p);g.log("Failed to setLocalDescription, ",p)})},function(o){n.emit("error",o);g.log("Failed to createOffer, ",o)})};k.prototype._makeAnswer=function(){var n=this;this.pc.createAnswer(function(o){g.log("Created answer.");if(g.browserisms==="Webkit"){o.sdp=a.higherBandwidthSDP(o.sdp)}n.pc.setLocalDescription(o,function(){g.log("Set localDescription to answer.");n._socket.send({type:"ANSWER",payload:{sdp:o},dst:n.peer})},function(p){n.emit("error",p);g.log("Failed to setLocalDescription, ",p)})},function(o){n.emit("error",o);g.log("Failed to create answer, ",o)})};k.prototype._cleanup=function(){g.log("Cleanup ConnectionManager for "+this.peer);if(!!this.pc&&(this.pc.readyState!=="closed"||this.pc.signalingState!=="closed")){this.pc.close();this.pc=null}var n=this;this._socket.send({type:"LEAVE",dst:n.peer});this.open=false;this.emit("close")};k.prototype._attachConnectionListeners=function(o){var n=this;o.on("close",function(){if(!!n.connections[o.label]){delete n.connections[o.label]}if(!Object.keys(n.connections).length){n._cleanup()}});o.on("open",function(){n._lock=false;n._processQueue()})};k.prototype.handleSDP=function(n,p){n=new RTCSessionDescription(n);var o=this;this.pc.setRemoteDescription(n,function(){g.log("Set remoteDescription: "+p);if(p==="OFFER"){o._makeAnswer()}},function(q){o.emit("error",q);g.log("Failed to setRemoteDescription, ",q)})};k.prototype.handleCandidate=function(o){var n=new RTCIceCandidate(o.candidate);this.pc.addIceCandidate(n);g.log("Added ICE candidate.")};k.prototype.handleLeave=function(){g.log("Peer "+this.peer+" disconnected.");this.close()};k.prototype.close=function(){if(!this.open){this.emit("error",new Error("Connections to "+this.peer+"are already closed."));return}var r=Object.keys(this.connections);for(var p=0,q=r.length;p<q;p+=1){var o=r[p];var n=this.connections[o];n.close()}this.connections=null;this._cleanup()};k.prototype.connect=function(p){if(!this.open){return}p=g.extend({label:"peerjs",reliable:(g.browserisms==="Firefox")},p);while(!!this.connections[p.label]){p.label="peerjs"+this._default;this._default+=1}this.labels[p.label]=p;var n;if(!!this.pc&&!this._lock){var q=g.browserisms==="Firefox"?p.reliable:false;n=this.pc.createDataChannel(p.label,{reliable:q});if(g.browserisms==="Firefox"){this._makeOffer()}}var o=new e(this.peer,n,p);this._attachConnectionListeners(o);this.connections[p.label]=o;if(!this.pc||this._lock){this._queued.push(o)}this._lock=true;return o};k.prototype.update=function(q){var r=Object.keys(q);for(var o=0,p=r.length;o<p;o+=1){var n=r[o];this.labels[n]=q[n]}};function b(r,n,p,u){if(!(this instanceof b)){return new b(r,n,p,u)}m.call(this);this._id=u;var o=g.randomToken();this.disconnected=false;var s=g.isSecure();var t=s?"https://":"http://";var q=s?"wss://":"ws://";this._httpUrl=t+r+":"+n+"/"+p+"/"+u+"/"+o;this._wsUrl=q+r+":"+n+"/peerjs?key="+p+"&id="+u+"&token="+o}g.inherits(b,m);b.prototype.start=function(){this._startXhrStream();this._startWebSocket()};b.prototype._startWebSocket=function(){var n=this;if(!!this._socket){return}this._socket=new WebSocket(this._wsUrl);this._socket.onmessage=function(o){var p;try{p=JSON.parse(o.data)}catch(q){g.log("Invalid server message",o.data);return}n.emit("message",p)};this._socket.onopen=function(){if(!!n._timeout){clearTimeout(n._timeout);setTimeout(function(){n._http.abort();n._http=null},5000)}g.log("Socket open")}};b.prototype._startXhrStream=function(q){try{var o=this;this._http=new XMLHttpRequest();this._http._index=1;this._http._streamIndex=q||0;this._http.open("post",this._httpUrl+"/id?i="+this._http._streamIndex,true);this._http.onreadystatechange=function(){if(this.readyState==2&&!!this.old){this.old.abort();delete this.old}if(this.readyState>2&&this.status==200&&!!this.responseText){o._handleStream(this)}};this._http.send(null);this._setHTTPTimeout()}catch(p){g.log("XMLHttpRequest not available; defaulting to WebSockets")}};b.prototype._handleStream=function(p){var r=p.responseText.split("\n");if(!!p._buffer){while(p._buffer.length>0){var o=p._buffer.shift();var n=r[o];try{n=JSON.parse(n)}catch(s){p._buffer.shift(o);break}this.emit("message",n)}}var q=r[p._index];if(!!q){p._index+=1;if(p._index===r.length){if(!p._buffer){p._buffer=[]}p._buffer.push(p._index-1)}else{try{q=JSON.parse(q)}catch(s){g.log("Invalid server message",q);return}this.emit("message",q)}}};b.prototype._setHTTPTimeout=function(){var n=this;this._timeout=setTimeout(function(){var o=n._http;if(!n._wsOpen()){n._startXhrStream(o._streamIndex+1);n._http.old=o}else{o.abort()}},25000)};b.prototype._wsOpen=function(){return !!this._socket&&this._socket.readyState==1};b.prototype.send=function(q){if(this.disconnected){return}if(!q.type){this.emit("error","Invalid message");return}var p=JSON.stringify(q);if(this._wsOpen()){this._socket.send(p)}else{var o=new XMLHttpRequest();var n=this._httpUrl+"/"+q.type.toLowerCase();o.open("post",n,true);o.setRequestHeader("Content-Type","application/json");o.send(p)}};b.prototype.close=function(){if(!this.disconnected&&this._wsOpen()){this._socket.close();this.disconnected=true}}})(this);function maqawAjaxPost(a,c,j){var k;if(typeof XMLHttpRequest!=="undefined"){k=new XMLHttpRequest()}else{var b=["MSXML2.XmlHttp.5.0","MSXML2.XmlHttp.4.0","MSXML2.XmlHttp.3.0","MSXML2.XmlHttp.2.0","Microsoft.XmlHttp"];for(var f=0,g=b.length;f<g;f++){try{k=new ActiveXObject(b[f]);break}catch(h){}}}k.onreadystatechange=d;function d(){if(k.readyState===4){j(k)}}k.open("POST",a,true);k.setRequestHeader("Content-type","application/x-www-form-urlencoded");k.send(c)}var docCookies={getItem:function(a){return decodeURI(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURI(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(d,g,c,b,a,e){if(!d||/^(?:expires|max\-age|path|domain|secure)$/i.test(d)){return false}var f="";if(c){switch(c.constructor){case Number:f=c===Infinity?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+c;break;case String:f="; expires="+c;break;case Date:f="; expires="+c.toGMTString();break}}document.cookie=encodeURI(d)+"="+encodeURI(g)+f+(a?"; domain="+a:"")+(b?"; path="+b:"")+(e?"; secure":"");return true},removeItem:function(b,a){if(!b||!this.hasItem(b)){return false}document.cookie=encodeURI(b)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(a?"; path="+a:"");return true},hasItem:function(a){return(new RegExp("(?:^|;\\s*)"+encodeURI(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=")).test(document.cookie)}};function ChatSession(m,l,d,n,o,c){this.srcName=d;this.dstName=n;this.dstId=o;var i=this;this.peer=l;var g=false;var b;this.isSendingAllowed=false;this.connectionCallback=c;this.mainContainer=m;this.textDisplay;this.textDisplay=document.createElement("DIV");this.textDisplay.className="chat-display";this.mainContainer.appendChild(this.textDisplay);this.textDisplay.addEventListener("load",function(){alert("hi")},false);this.textDisplay.innerHTML="Questions or feedback? We're online and ready to help you!";this.textInput;this.textInput=document.createElement("textarea");this.textInput.className="chat-entry";this.textInput.setAttribute("placeholder","Type and hit enter to chat");this.mainContainer.appendChild(this.textInput);try{this.textInput.addEventListener("keyup",a,false)}catch(k){this.textInput.attachEvent("onkeyup",a)}function a(s){if(s.keyCode===13){var t=i.textInput.value;i.textInput.value="";f(t);i.scrollToBottom()}}function f(e){if(/\S/.test(e)){if(b){b.send(e)}i.textDisplay.innerHTML=i.textDisplay.innerHTML+"<p class='chat-paragraph'><span class='chat-src-name'>"+i.srcName+": </span>"+e+"</p>"}}function h(e){if(/\S/.test(e)){i.textDisplay.innerHTML=i.textDisplay.innerHTML+"<p class='chat-paragraph'><span class='chat-dest-name'>"+i.dstName+": </span>"+e+"</p>";i.scrollToBottom()}}function q(){if(i.connectionCallback){i.connectionCallback(i.getIsConnected())}}this.peer.on("connection",r);function r(e){g=true;q();b=e;b.on("data",function(s){console.log(s);h(s)});b.on("close",function(s){g=false;f("Your chat buddy has disconnected :(");q()})}this.scrollToBottom=function(){i.textDisplay.scrollTop=i.textDisplay.scrollHeight};this.getText=function(){return i.textDisplay.innerHTML};this.setText=function(e){i.textDisplay.innerHTML=e};this.openConnection=function(){if(i.dstId){var e=i.peer.connect(i.dstId);e.on("open",function(){r(e)});e.on("error",function(s){console.log("Connection error: "+s)})}};this.getIsConnected=function(){return g};this.disconnect=function(){if(g){b.close()}};this.setAllowMessageSending=function(e){if(e!==i.isSendingAllowed){if(e){j()}else{p()}i.isSendingAllowed=e}};function p(){if(i.textInput){i.textInput.disabled=true}console.log("disallow messages")}function j(){if(i.textInput){i.textInput.disabled=false}}this.openConnection()}ChatSession.prototype.getContainer=function(){return this.mainContainer};function VisitorSession(c){var f=this;this.chatSession;this.maqawManager=c;this.isRepAvailable=false;this.header=document.createElement("DIV");this.header.className="maqaw-default-client-header";this.body=document.createElement("DIV");this.loginHeader=document.createElement("DIV");this.loginHeader.innerHTML="Chat with me!";this.loginHeader.className="maqaw-chat-header-text";this.visitorChatWindow=document.createElement("DIV");this.visitorChatWindow.className="client-chat-window";var i=document.createElement("DIV");this.visitorChatWindow.appendChild(i);i.innerHTML="";this.chatSession=new ChatSession(i,f.maqawManager.peer,"src","dst");var b;b=document.createElement("DIV");b.id="chat-footer";this.visitorChatWindow.appendChild(b);var d;d=document.createElement("DIV");d.id="login-button";d.innerHTML="Login";b.appendChild(d);d.addEventListener("click",this.maqawManager.loginClicked,false);var h;h=document.createElement("DIV");h.id="maqaw-link";h.innerHTML='POWERED BY <a href="http://maqaw.com">MAQAW</a>';b.appendChild(h);this.noRepWindow=document.createElement("DIV");this.noRepWindow.id="maqaw-no-rep-window";this.noRepWindow.className="client-chat-window";this.noRepWindow.innerHTML="";var g=document.createElement("DIV");g.className="chat-display";g.innerHTML="Sorry, there are no representatives available to chat";this.noRepWindow.appendChild(g);this.noRepHeader=document.createElement("DIV");this.noRepHeader.innerHTML="Send us an email!";this.noRepHeader.className="maqaw-chat-header-text";var k;k=document.createElement("DIV");k.id="chat-footer";this.noRepWindow.appendChild(k);var j;j=document.createElement("DIV");j.id="login-button";j.innerHTML="Login";k.appendChild(j);j.addEventListener("click",this.maqawManager.loginClicked,false);var h;h=document.createElement("DIV");h.id="maqaw-link";h.innerHTML='POWERED BY <a href="http://maqaw.com">MAQAW</a>';k.appendChild(h);function a(){f.body.innerHTML="";f.body.appendChild(f.visitorChatWindow);f.header.innerHTML="";f.header.appendChild(f.loginHeader)}function e(){f.body.innerHTML="";f.body.appendChild(f.noRepWindow);f.header.innerHTML="";f.header.appendChild(f.noRepHeader)}this.setIsRepAvailable=function(l){if(l!==f.isRepAvailable){if(l){a()}else{e()}}this.isRepAvailable=l};e();this.getSessionData=function(){return{chatText:f.chatSession.getText()}};this.loadSessionData=function(l){f.chatSession.setText(l.chatText)}}VisitorSession.prototype.getBodyContents=function(){return this.body};VisitorSession.prototype.getHeaderContents=function(){return this.header};function MaqawManager(f){var e=this,h="cat",i="ec2-54-214-126-127.us-west-2.compute.amazonaws.com",b=3000;this.id=docCookies.getItem("peerId");this.key=h;this.representatives;this.maqawDisplay=f;this.visitorSession;this.repSession;this.loginPage=new LoginPage(this);this.visitors=[];if(this.id){this.peer=new Peer(this.id,{key:h,host:i,port:b})}else{this.peer=new Peer({key:h,host:i,port:b})}this.peer.on("open",function(j){e.id=j;console.log("My id: "+j);docCookies.setItem("peerId",j,Infinity)});this.peer.on("clients",function(j){console.log("visitors: "+j.msg);e.visitors=j.msg;e.repSession&&e.repSession.updateVisitorList(j.msg)});this.peer.on("representatives",function(j){console.log("Reps: "+j.msg);e.representatives=j.msg;d()});this.loginClicked=function(){e.maqawDisplay.setHeaderContents(e.loginPage.getHeaderContents());e.maqawDisplay.setBodyContents(e.loginPage.getBodyContents())};this.logoutClicked=function(){docCookies.removeItem("maqawRepLoginCookie");localStorage.removeItem("maqawRepSession");e.showVisitorSession()};this.showVisitorSession=function(){e.maqawDisplay.setHeaderContents(e.visitorSession.getHeaderContents());e.maqawDisplay.setBodyContents(e.visitorSession.getBodyContents())};this.startVisitorSession=function(){var k=new VisitorSession(e);var j=JSON.parse(localStorage.getItem("maqawVisitorSession"));if(j){k.loadSessionData(j)}e.visitorSession=k};this.startNewRepSession=function(k){e.repSession=new RepSession(e,k);if(e.loadPreviousRepSession){var j=JSON.parse(localStorage.getItem("maqawRepSession"));if(j){e.repSession.loadSessionData(j);e.repSession.updateVisitorList(e.visitors)}}e.maqawDisplay.setHeaderContents(e.repSession.getHeaderContents());e.maqawDisplay.setBodyContents(e.repSession.getBodyContents())};this.loadRepSession=function(){var j=docCookies.getItem("maqawRepLoginCookie");if(j===null){return false}e.loginPage.loginWithParams(j);e.loadPreviousRepSession=true;return true};function d(){e.visitorSession.setIsRepAvailable(e.representatives.length!==0)}function c(){if(typeof e.visitorSession!=="undefined"){var k=e.visitorSession.getSessionData();var j=JSON.stringify(k);localStorage.setItem("maqawVisitorSession",j)}}function g(){if(typeof e.repSession!=="undefined"){var k=e.repSession.getSessionData();var j=JSON.stringify(k);console.log(j);localStorage.setItem("maqawRepSession",j)}}function a(){c();g()}window.addEventListener("unload",a,false)}MaqawManager.prototype.setVisitorSession=function(a){this.visitorSession=a};function MaqawManager(f){var e=this,h="cat",i="ec2-54-214-126-127.us-west-2.compute.amazonaws.com",b=3000;this.id=docCookies.getItem("peerId");this.key=h;this.representatives;this.maqawDisplay=f;this.visitorSession;this.repSession;this.loginPage=new LoginPage(this);this.visitors=[];if(this.id){this.peer=new Peer(this.id,{key:h,host:i,port:b})}else{this.peer=new Peer({key:h,host:i,port:b})}this.peer.on("open",function(j){e.id=j;console.log("My id: "+j);docCookies.setItem("peerId",j,Infinity)});this.peer.on("clients",function(j){console.log("visitors: "+j.msg);e.visitors=j.msg;e.repSession&&e.repSession.updateVisitorList(j.msg)});this.peer.on("representatives",function(j){console.log("Reps: "+j.msg);e.representatives=j.msg;d()});this.loginClicked=function(){e.maqawDisplay.setHeaderContents(e.loginPage.getHeaderContents());e.maqawDisplay.setBodyContents(e.loginPage.getBodyContents())};this.logoutClicked=function(){docCookies.removeItem("maqawRepLoginCookie");localStorage.removeItem("maqawRepSession");e.showVisitorSession()};this.showVisitorSession=function(){e.maqawDisplay.setHeaderContents(e.visitorSession.getHeaderContents());e.maqawDisplay.setBodyContents(e.visitorSession.getBodyContents())};this.startVisitorSession=function(){var k=new VisitorSession(e);var j=JSON.parse(localStorage.getItem("maqawVisitorSession"));if(j){k.loadSessionData(j)}e.visitorSession=k};this.startNewRepSession=function(k){e.repSession=new RepSession(e,k);if(e.loadPreviousRepSession){var j=JSON.parse(localStorage.getItem("maqawRepSession"));if(j){e.repSession.loadSessionData(j);e.repSession.updateVisitorList(e.visitors)}}e.maqawDisplay.setHeaderContents(e.repSession.getHeaderContents());e.maqawDisplay.setBodyContents(e.repSession.getBodyContents())};this.loadRepSession=function(){var j=docCookies.getItem("maqawRepLoginCookie");if(j===null){return false}e.loginPage.loginWithParams(j);e.loadPreviousRepSession=true;return true};function d(){e.visitorSession.setIsRepAvailable(e.representatives.length!==0)}function c(){if(typeof e.visitorSession!=="undefined"){var k=e.visitorSession.getSessionData();var j=JSON.stringify(k);localStorage.setItem("maqawVisitorSession",j)}}function g(){if(typeof e.repSession!=="undefined"){var k=e.repSession.getSessionData();var j=JSON.stringify(k);console.log(j);localStorage.setItem("maqawRepSession",j)}}function a(){c();g()}window.addEventListener("unload",a,false)}MaqawManager.prototype.setVisitorSession=function(a){this.visitorSession=a};function MaqawDisplay(a){this.startMinimized=false}MaqawDisplay.prototype.setup=function(){var a;a=document.createElement("DIV");a.id="chat-container";document.body.appendChild(a);this.clientHeader=document.createElement("DIV");a.appendChild(this.clientHeader);this.clientBody=document.createElement("DIV");a.appendChild(this.clientBody);var c=this.startMinimized;if(c){this.clientBody.style.dislay="none"}else{this.clientBody.style.dislay="block"}var d=this;function b(){if(c){d.clientBody.style.display="block";c=false}else{d.clientBody.style.display="none";c=true}}this.clientHeader.addEventListener("click",b,false)};MaqawDisplay.prototype.setHeaderContents=function(a){this.clientHeader.innerHTML="";this.clientHeader.appendChild(a)};MaqawDisplay.prototype.setBodyContents=function(a){this.clientBody.innerHTML="";this.clientBody.appendChild(a)};function Representative(a){this.name=a}function RepSession(d,i){this.maqawManager=d;this.rep=i;var h=this;this.body=document.createElement("DIV");this.header=document.createElement("DIV");this.header.className="maqaw-default-client-header";var g=document.createElement("DIV");g.innerHTML="Welcome!";g.className="maqaw-chat-header-text";this.header.appendChild(g);var b=document.createElement("DIV");this.body.appendChild(b);var j=document.createElement("DIV");j.id="logged-in-chat-window";b.appendChild(j);var a=document.createElement("DIV");j.appendChild(a);var l=document.createElement("DIV");l.id="logged-in-chat-footer";j.appendChild(l);var e=document.createElement("DIV");e.id="logout-button";e.innerHTML="Logout";l.appendChild(e);e.addEventListener("click",this.maqawManager.logoutClicked,false);var k=document.createElement("DIV");k.id="logged-in-dashboard";b.appendChild(k);var f=document.createElement("DIV");f.id="dashboard-title";f.innerHTML="Visitors";k.appendChild(f);var c=document.createElement("DIV");c.id="visitor-list-container";k.appendChild(c);this.chatManager=new ChatManager(a);this.visitorList=new VisitorList(c,this.chatManager,this.maqawManager);this.updateVisitorList=function(m){h.visitorList.setVisitorList(m)};this.loadSessionData=function(m){h.visitorList.loadListData(m)};this.getSessionData=function(){return h.visitorList.getListData()};this.updateVisitorList(this.maqawManager.visitors)}RepSession.prototype.getBodyContents=function(){return this.body};RepSession.prototype.getHeaderContents=function(){return this.header};function Visitor(c,a,e,b){var d=this;this.name=a;this.id=e;this.chatSession=new ChatSession(document.createElement("DIV"),c.peer,"You",a,e,b);this.getChatSession=function(){return d.chatSession};this.getId=function(){return d.id}}function VisitorList(a,e,d){var b=this;this.visitors={};this.listDisplayContainer=a;this.chatManager=e;this.maqawManager=d;this.selectedVisitor;this.visitorCounter=0;this.table=document.createElement("table");this.table.id="visitor-list-table";this.tBody=document.createElement("tbody");this.table.appendChild(this.tBody);this.listDisplayContainer.appendChild(this.table);this.setVisitorList=function(g){if(g){for(var f=0;f<g.length;f++){var l=g[f];var h=b.visitors[l];if(typeof h==="undefined"){b.visitors[l]=c(l)}else{if(!h.getIsConnected()){h.setServerConnectionStatus(true)}}}}for(var j in b.visitors){var k=false;for(f=0;f<g.length;f++){if(j===g[f]){k=true;break}}if(!k){b.visitors[j].setServerConnectionStatus(false)}}};function c(g){var f="Visitor "+b.visitorCounter;b.visitorCounter++;return new VisitorWrapper(g,f,b,-1)}this.setSelectedVisitor=function(f){if(b.selectedVisitor){b.selectedVisitor.deselect();if(b.selectedVisitor===f){b.selectedVisitor=undefined;return}}f.select();b.selectedVisitor=f};this.hideVisitor=function(f){if(b.selectedVisitor&&b.selectedVisitor===f){b.selectedVisitor=undefined}};this.getListData=function(){var i={};var f=0;for(var j in b.visitors){var h=b.visitors[j];var g={name:h.visitor.name,id:h.getId(),isSelected:h.isSelected,rowIndex:h.row.rowIndex,chatText:h.visitor.getChatSession().getText()};i[f]=g;f++}return i};this.loadListData=function(i){b.visitors={};b.tBody.innerHTML="";for(var f in i){var h=i[f];var g=new VisitorWrapper(h.id,h.name,b,-1);if(h.isSelected){b.selectedVisitor=g;g.select()}g.visitor.getChatSession().setText(h.chatText);b.visitors[g.getId()]=g}}}function VisitorWrapper(c,b,e,h){var g=this;this.visitorList=e;this.isConnectedToServer=true;this.isChatConnected=false;this.visitor=new Visitor(this.visitorList.maqawManager,b,c,d);this.row=e.table.insertRow(h);this.row.className="visitor-list-entry";var j=document.createElement("td");var l=document.createTextNode(this.visitor.name);j.appendChild(l);this.row.appendChild(j);this.visitorList.tBody.appendChild(this.row);this.isSelected=false;this.row.addEventListener("click",k,false);function k(){g.visitorList.setSelectedVisitor(g)}f();this.select=function(){g.isSelected=true;g.row.className="selected-visitor";g.visitorList.chatManager.showVisitorChat(g.visitor)};this.deselect=function(){g.isSelected=false;g.row.className="visitor-list-entry";g.visitorList.chatManager.clear(g.visitor)};this.getVisitor=function(){return g.visitor};this.getId=function(){return g.visitor.getId()};this.getIsConnected=function(){return g.isConnectedToServer};this.openConnection=function(){g.visitor.getChatSession().openConnection()};this.setServerConnectionStatus=function(m){if(!g.isConnectedToServer&&m){g.visitor.getChatSession().openConnection()}g.isConnectedToServer=m;a()};function a(){g.visitor.chatSession.setAllowMessageSending(g.isConnectedToServer&&g.isChatConnected)}function d(m){g.isChatConnected=m;a();if(!g.isChatConnected){f()}else{i()}}function f(){g.row.style.display="none";g.visitorList.hideVisitor(g);g.isSelected=false;g.row.className="visitor-list-entry";g.visitorList.chatManager.clear(g.visitor)}function i(){g.row.style.display="block"}}var maqawDisplay=new MaqawDisplay(false);maqawDisplay.setup();var maqawManager=new MaqawManager(maqawDisplay);maqawManager.startVisitorSession();var repSessionStarted=maqawManager.loadRepSession();if(!repSessionStarted){maqawManager.showVisitorSession()};